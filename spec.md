# いっしょにタスク 仕様書

## 仕様に直接影響する前提（Constitution要約）
- Cloudflare Workersで稼働する。Node.js専用APIは使わず、nodejs_compatは原則OFF、payloadは小さく設計する。
- 周期境界の判定はJST(Asia/Tokyo)固定とし、期間は `period_start <= t < period_end` の半開区間（period_endは次周期開始時刻）とする。
- 認証/認可はSupabase Auth + RLSを必須とし、チーム境界/権限制御はDBで強制する。
- Schema First：API入出力はZod Schemaを単一ソースとし、packages/sharedの型をフロント/バックで共有する。
- APIレスポンスは統一フォーマット（成功: `data/meta`, 失敗: `error.code/message/details`）で返す。
- 入力バリデーションはparams/query/bodyの全てをZodで検証する（@hono/zod-validator）。
- 実行/運用はDocker不使用。webはVite dev server、apiはwrangler dev/deployを用いる。
- キャッシュは正しさ優先で原則OFF。サマリ系GETで使う場合は `user_id/team_id/period` をキーに含め、TTLは30-120秒、更新後は必ず再取得する。

## ユーザーストーリー

### P1: 家事実績をすばやく記録し、今期の貢献度を確認したい
- オーナー/メンバーとしてチームを作成し、家事/イベントマスタを登録して実績を10秒以内で入力できる。
- 登録した実績が今期集計に即時反映され、ポイント合計と内訳が見える。

### P2: 家族を招待してチームで使いたい
- オーナーが招待リンクを発行し、家族がリンク経由で参加できる。
- チーム全員のポイントが周期ごとに集計・閲覧できる。

### P2: 実績の編集/削除と履歴確認をしたい
- 本人またはオーナーが当期内（+周期終了後24時間）に限り実績を編集/削除できる。
- 自分の履歴を時系列で遡れる。

### P3: 過去周期や管理系情報を確認したい
- 過去周期の集計・履歴を参照できる（閲覧のみ）。
- オーナーが監査ログやチーム設定（精算周期/オーナー移譲など）を確認・操作できる。

## 機能要件
- **FR-001**: ユーザーはSupabase Authでサインアップ/ログインできる（メール=マジックリンク、Google、Apple）。
- **FR-002**: 初回ログイン時にニックネーム登録を必須化し、チーム内で一意であることを担保する。メールアドレスは画面に表示しない。ニックネームは1-20文字（前後空白トリム後）で、改行/タブなど制御文字は不可。ASCII英字は大文字小文字を同一視して一意判定する。変更はユーザーが任意に可能で回数制限は設けない。
- **FR-003**: チームの作成/一覧/切替ができる。チーム名の重複は許可し、識別はIDで行う。
- **FR-004**: 招待リンクを発行/失効できる（オーナーのみ）。リンクは発行から7日で期限切れ、同時有効は1本まで。
- **FR-005**: 招待リンクはURL生成のみで、アプリからのメール送信は行わない。
- **FR-006**: 招待リンクを踏んだアカウントがチーム参加できる（招待メールアドレス一致は必須にしない）。未ログインの場合はログイン要求し、ログイン後に受諾フローへ戻す。既にメンバーの場合は「参加済み」表示でNo-opとする。期限切れ/失効/不正トークンはエラー表示する。
- **FR-007**: メンバー一覧はチーム全員が閲覧でき、status(active/removed/deleted)を表示する。deletedは「退会済み」と表示する。
- **FR-008**: メンバー自身による退出は不可。オーナーのみメンバー削除ができ、削除後も過去実績は保持・表示する。削除後の再参加は不可とし、再招待する場合は新規ユーザー（別user_id）として扱う。
- **FR-009**: 退会（アカウント削除）時はログイン不能にし、全チームから自動脱退する。過去実績は保持し、表示名は退会時点のニックネームを固定する。
- **FR-010**: 家事/イベントマスタはオーナーのみ登録/編集/無効化できる。名称はチーム内で一意、ポイントは1-99、カテゴリはhousework/eventとする。
- **FR-011**: マスタ無効化後も過去実績は表示し、マスタには「廃止」ラベルを付ける。
- **FR-012**: 実績はマスタ選択＋実施日時＋メモ(任意)で登録できる。実施日時は当期内のみ許可し、既定は現在時刻（JST）。
- **FR-013**: 実績登録は今期集計に即時反映される。オフライン/通信失敗時はエラー表示し、下書き保存・自動再送は行わない（MVP）。
- **FR-014**: 実績の編集/削除は本人またはオーナーに限定し、当期内（+周期終了後24時間）に限り許可する。編集可能項目はマスタ/実施日時/メモとし、実施日時は当期内のみ許可する。猶予はperiod_endから24時間（JST）までとする。
- **FR-015**: 実績の履歴一覧はperformed_at降順でページング表示する（1ページ既定50件）。
- **FR-016**: 周期集計は今期/前期/任意期間を選択でき、メンバー別ポイント合計と内訳を表示する。表示順はニックネーム昇順とする。
- **FR-017**: 過去周期の集計・履歴を参照できる。周期一覧は直近24期を表示し、追加はページングで取得する。
- **FR-018**: 精算周期はチームごとに週次/月次を設定できる（週次=月曜開始、月次=暦月）。変更は次周期から適用し、現在の周期は維持する。次周期開始は、週次変更時は次の月曜00:00、月次変更時は次月1日00:00（いずれもJST）とする。
- **FR-019**: オーナー移譲は専用フローのみで実行でき、候補が複数の場合はjoined_atが最も古いメンバーに自動移譲する。
- **FR-020**: 実績登録時点のポイントとニックネームをスナップショットとして保存し、後からの変更に影響されない。編集時にマスタを変更した場合はpoints_snapshotを当該マスタの現在値に更新するが、ニックネームのスナップショットは更新しない。
- **FR-021**: 監査ログは主要操作（チーム設定変更、マスタ作成/更新/無効化、招待リンク発行/受諾、メンバー削除、オーナー移譲、実績編集/削除）を記録し、オーナーのみ閲覧できる。
- **FR-022**: オーナーはマスタの表示順を並び替えできる（手動並び替えUIを提供し、並び順は永続化する）。

## 非機能要件
- **NFR-001**: Cloudflare Workers互換を満たす（Node.js専用API不使用、nodejs_compat原則OFF、payloadは小さく設計）。
- **NFR-002**: セキュリティ境界はRLSで強制し、未参加チームのデータ参照/更新は拒否される。
- **NFR-003**: API入出力はZod Schemaを単一ソースにし、params/query/bodyは全てZodで検証する。
- **NFR-004**: APIレスポンスは統一形式（成功: data/meta、失敗: code/message/details）で返す。
- **NFR-005**: ログはdebug/info/warn/errorを使い分け、PII（メール/招待トークン等）を出力しない。
- **NFR-006**: モバイルブラウザでの実績登録は10秒以内で完了できる導線を提供する。
- **NFR-007**: 一覧表示はページング必須とし、初回表示の性能目標は3秒以内（モバイル回線想定）とする。TaskLogは1周期あたり最大500件を想定する。
- **NFR-008**: ローカル開発はVite dev serverとwrangler devを使用し、Dockerは使わない。
- **NFR-009**: 監査ログの保存期間は1年とし、削除は定期ジョブで実施する。
- **NFR-010**: サマリ系GETでキャッシュを利用する場合は `user_id/team_id/period` をキーに含め、TTLは30-120秒、更新後は再取得する。
- **NFR-011**: MVPではサマリ系GETのキャッシュを利用しない。

## 受け入れ条件
- 主要ユースケース（チーム作成、マスタ登録、実績登録、今期集計）がスマホブラウザでデモできる。
- 入力バリデーション（必須・型・範囲）とユーザー向けエラー表示がある。
- RLSにより、未参加チームのデータ取得とメンバー権限でのマスタ/設定変更が拒否される。
- 周期集計が設定に従って表示され、週次は月曜開始、月次は暦月、表示順はニックネーム昇順である。
- 実績登録が集計に即時反映され、遅延がある場合はUIで説明される。
- 実績の編集/削除は「本人またはオーナー」かつ「当期内（+周期終了後24時間）」に限定される。
- オーナー不在になる操作が防止され、移譲フローでのみオーナー変更できる。
- 監査ログが主要操作で記録され、オーナーのみ閲覧でき、保存期間は1年である。
- 集計が全期間（過去周期）で参照でき、周期一覧は直近24期+ページングである。
- 履歴一覧がページングで閲覧でき、performed_at降順、1ページ既定50件である。
- 本番デプロイ（Cloudflare Workers）され、URLでアクセスできる。
- READMEにローカル起動、環境変数、デプロイ手順が記載されている。

## 未確定事項（要確認）
- 現時点ではなし。
