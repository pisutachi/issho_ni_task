# いっしょにタスク（issho_ni_task）

## 背景・目的
- 背景：家族内の家事/用事の分担が見えづらく、不公平感や「やった/やってない」の揉め事が起きやすい。
- 目的：家事・イベントの実績を“入力が楽”に記録し、精算周期（週次/月次）ごとにポイントを可視化して合意形成を支援する。
- 成功条件（MVP）：
  - 1回の実績登録が10秒以内で完了できる（スマホ想定）。
  - 1チーム内で「誰がどれだけやったか」を周期ごとに確認でき、リセット（=新しい周期が始まること）が正しく動く。
  - 過去周期の集計・履歴を参照できる（閲覧のみ）。
  - 権限により、他チーム/他人のデータにアクセスできない（RLSで担保）。

## 対象ユーザー
- 家族利用（同居/別居どちらも想定）
- ロール：
  - チームオーナー：チーム作成、メンバー招待、精算周期設定、マスタ管理（家事/イベント）、チーム設定、他メンバーの実績編集/削除
  - メンバー：実績登録、ポイント閲覧、自分の実績編集/削除
- 表示名：チーム内はニックネーム必須（メールアドレスはどの画面でも表示しない）。
- 利用頻度：毎日〜週数回
- デバイス：スマホ中心（iOS/Androidのモバイルブラウザ）、PCは補助
- 言語/地域：日本語（日本）

## 主要ユースケース（3〜7）
1. チーム作成・参加
   - きっかけ：新しく家族で使い始める
   - 入力：チーム名
   - 処理：チーム作成、オーナー設定
   - 出力：チームのホームが表示される
   - 例外：同名チームは許可（識別はID）

2. メンバー招待
   - 入力：招待先メールアドレス（任意。送信する場合のみ）、または招待リンク発行
   - 処理：招待の作成、受諾でチーム参加（リンクを踏んだアカウント）
   - 補足：未ログイン時はログイン要求し、ログイン後に受諾フローへ戻す。既にメンバーの場合は「参加済み」表示でNo-op
   - 期限：7日
   - 出力：メンバー一覧に反映
   - 例外：期限切れ/権限不足/トークン不正

3. 家事/イベントマスタの登録・編集（チーム単位）
   - 入力：名称、カテゴリ（家事/イベント）、ポイント、表示順（任意）
   - 制約：同一チーム内で名称は一意（重複不可）
   - 処理：マスタ作成/更新/無効化（編集権限はオーナーのみ）
   - 出力：マスタ一覧に反映
   - 無効化：過去実績は表示し、マスタには「廃止」ラベルを付ける
   - 例外：ポイントが不正（0以下/上限超え）

4. 実績登録（家事/イベント）
   - 入力：マスタ選択、実施日時（既定=現在）、メモ（任意）
   - 処理：実績を記録し、周期集計に反映
   - 出力：自分の履歴に追加
   - 例外：オフライン/通信失敗時はエラー表示（下書き保存・自動再送はMVPでは行わない）

5. 周期集計の閲覧（自分/チーム）
   - 入力：チーム選択、対象周期（任意の過去周期も含む）
   - 処理：メンバー別ポイント合計、内訳を表示
   - 出力：一覧表示（ニックネーム昇順で表示）
   - 表示ルール：削除されたメンバーの過去実績も表示し、表示名は当時のニックネームのまま

6. 精算周期の設定（週次/月次）
   - 入力：週次/月次
   - ルール：
     - 週次：月曜開始（JST）
     - 月次：暦月（毎月1日00:00開始、次月1日00:00まで、JST）
     - 期間は period_start <= t < period_end の半開区間（JST）
     - 変更は次周期から適用し、週次への変更は次の月曜00:00、月次への変更は次月1日00:00（JST）
   - 処理：チーム設定に保存し、次周期から集計境界に反映
   - 出力：設定保存後、現在の周期は維持する

## 画面一覧と簡易フロー
- 画面一覧
  - ログイン/サインアップ（メール・Google・Apple）
  - 初回プロフィール設定（ニックネーム登録）
  - チーム一覧（複数チーム切替）
  - チームホーム（今期サマリ：自分/全員）
  - 実績登録（クイック登録）
  - 履歴（自分の実績一覧、編集/削除、ページング、performed_at降順）
  - マスタ管理（家事/イベント：一覧・追加・編集）※オーナーのみ
  - 集計（周期一覧：直近24期を表示→選択→サマリ表示、過去はページングで追加取得）
  - 監査ログ（閲覧）※オーナーのみ
  - チーム設定（精算周期、メンバー管理/招待、招待リンク失効、オーナー移譲）※オーナーのみ
- 最短フロー（初回）
  1) サインアップ → 2) チーム作成 → 3) 招待送信 → 4) マスタ登録（最小セット）→ 5) 実績登録 → 6) 今期集計を確認

## データ（エンティティ概要）
- User（Supabase Auth）
- UserProfile：user_id, nickname（必須）, created_at, updated_at
  - ニックネーム：前後空白トリム後1-20文字、改行/タブなど制御文字は不可
  - 一意性：チーム内で大文字小文字を同一視（ASCII英字）して一意（TeamMemberと組み合わせて制約）
  - 変更：ユーザーが任意に更新可能（回数制限なし）
- Team：id, name, owner_user_id, settlement_cycle(week|month), cycle_rule_json(当面未使用), created_at
- TeamMember：team_id, user_id, role(owner|member), status(active|removed|deleted), joined_at, left_at(optional)
  - status=removed：オーナーによりチームから削除
  - status=deleted：ユーザー退会により自動脱退（メンバー一覧では「退会済み」と表示）
  - 再参加：status=removedは再参加不可。再招待する場合は新規ユーザーとして扱う
  - 表示期間：退会済み/削除済みの表示・実績参照は無期限
- TaskMaster：id, team_id, type(housework|event), name, points(int 1〜99), is_active, sort_order[TBD], created_at, updated_at
- TaskLog（実績）：id, team_id, user_id, task_master_id, points_snapshot, performer_nickname_snapshot, performed_at, memo, created_at, updated_at
  - ポイント：登録時点のpointsをpoints_snapshotとして保存。編集時にマスタ変更した場合は当該マスタの現在値へ更新する
  - 表示名：登録時点のニックネームをperformer_nickname_snapshotとして保存（退会/改名後も当時名で表示）。編集時も更新しない
  - 編集/削除：本人またはオーナーが可能（MVP）
  - 編集可能項目：マスタ/実施日時/メモ
  - 制約：当期（現在の精算周期）に属する実績のみ編集/削除可能。period_endから24時間（JST）までは猶予として編集/削除を許可（以後ロック）
  - 実施日時：当期内の日時のみ入力可能（既定=現在、JST）
  - メモ：任意
- SettlementPeriod（論理概念）：team_id, period_start, period_end（JST、period_start <= t < period_end。表示/集計用。基本はクエリで算出。テーブル化は[TBD]）
- TeamInvite：id, team_id, token, invite_email（任意）, expires_at, created_at, accepted_by_user_id（任意）, revoked_at(optional)
  - 招待方式：招待リンクURL生成（アプリ内メール送信はしない）
  - 有効期限：発行から7日
  - 同時発行：同一チームで有効な招待リンクは1本まで（新規発行で旧リンクは自動失効＝revoked_at付与）
  - 手動失効：オーナーが任意に失効できる
  - 旧リンクアクセス時：失効メッセージを表示し、オーナーへの再発行依頼を案内
  - 受諾条件：リンクを踏んでサインインしたアカウントをチーム参加させる（招待メールのアドレス一致は必須にしない）
  - 未ログイン時はログイン要求し、ログイン後に受諾フローへ戻す
  - 既にメンバーの場合は「参加済み」表示でNo-op
- AuditLog（監査ログ）：id, team_id, actor_user_id, actor_nickname_snapshot, action_type, target_type, target_id, metadata_json, created_at
  - 保存期間：1年（無料枠・運用簡素化のため。削除ジョブは[TBD]）
  - 対象操作（MVP）：チーム設定変更、マスタ作成/更新/無効化、招待リンク発行/受諾、メンバー削除、オーナー移譲、実績編集/削除

## 認証・認可
- 認証：Supabase Auth
  - メールアドレス：マジックリンク（パスワードは使用しない）
  - OAuth：Google、Apple
  - マジックリンクの有効期限：Supabase既定（当面変更しない）
- プロフィール：初回ログイン時にニックネーム登録を必須化（以後、チーム内表示に使用）。
  - ニックネームは前後空白トリム後1-20文字、改行/タブなど制御文字は不可。ASCII英字は大文字小文字を同一視。変更は任意で回数制限なし
- 認可：Supabase Row Level Security（必須）
  - TeamMember(status=active)に存在するユーザーのみ、当該team_id配下のTaskMaster/TaskLog/Team設定を参照可能
  - メンバー一覧はチーム全員が status(active/removed/deleted) を参照可能（deletedは「退会済み」表示）
  - マスタ管理/チーム設定はrole=ownerに限定
  - 監査ログ閲覧はrole=ownerに限定
  - 実績（TaskLog）の編集/削除は「本人またはオーナー」かつ「当期内（period_endから24時間の猶予、JST）」に限定
  - メンバー退出：メンバー自身による退出は不可（オーナーのみメンバー削除可能）
  - メンバー削除：削除後も過去実績は参照可能（表示名は当時のニックネームのまま）。再参加は不可で、再招待する場合は新規ユーザーとして扱う
  - 退会（アカウント削除）：ログイン不能にし、全チームから自動脱退。過去実績は保持（表示名は退会時点のニックネームを固定）
  - オーナー移譲：オーナーが不在になる操作（退会/削除/オーナー削除）は禁止し、事前に別メンバーへ強制移譲が必要
    - 宛先ルール：候補が複数の場合は「参加（joined_at）が最も古いメンバー」に自動移譲
- セッション：Supabase標準（更新/期限は既定）

## API要件（概要）
- ルーティング：Cloudflare Workers + Hono
- 主要エンドポイント（例）
  - GET /teams
  - POST /teams
  - POST /teams/:teamId/invites（招待：リンク発行）
    - 仕様：同時有効は1本（新規発行で旧リンクは自動失効）
  - POST /teams/:teamId/invites/:token/revoke（招待リンク失効：オーナーのみ）
  - POST /invites/:token/accept（招待受諾：リンクを踏んだアカウント）
    - 仕様：未ログインはログイン後に受諾、既にメンバーの場合はNo-op
  - GET /teams/:teamId/members
  - DELETE /teams/:teamId/members/:userId（メンバー削除：オーナーのみ）
    - 仕様：削除後も過去実績は保持/表示（表示名は当時のニックネーム）
  - POST /teams/:teamId/owner/transfer（オーナー移譲：オーナーのみ）
  - GET /teams/:teamId/task-masters?type=
  - POST /teams/:teamId/task-masters
  - PATCH /task-masters/:id
  - GET /teams/:teamId/task-logs?from=&to=&userId=&limit=50&cursor=（ページング対応：既定50件、performed_at降順）
  - POST /teams/:teamId/task-logs
  - PATCH /task-logs/:id（編集）
  - DELETE /task-logs/:id（削除）
  - GET /teams/:teamId/summary?period=current|previous|custom&from=&to=（全期間/任意期間に対応）
  - GET /teams/:teamId/periods?limit=24&cursor=（過去周期一覧：既定24期）
  - PATCH /teams/:teamId/settings（精算周期）
  - GET /me/profile
  - PATCH /me/profile（ニックネーム更新）
- バリデーション：Zod（@hono/zod-validator）
- キャッシュ：サマリ系GETはCache API対象候補（個人情報のため、キー設計/TTLは[TBD]）

## 非機能要件（性能/セキュリティ/ログ/運用）
- 性能
  - モバイルでの初回表示：[TBD] 秒以内
  - 一覧：TaskLogは1周期あたり最大 [TBD] 件を想定（ページング必須）
- セキュリティ
  - RLSでチーム境界を強制
  - メールアドレスはどの画面でも表示しない（Authにのみ保持）
  - 退会（アカウント削除）：ログイン不能＋全チーム自動脱退。ただし過去実績は保持し、表示名は退会時点のニックネームで固定
  - 重要操作は監査ログに記録（MVP）
- ログ/監視
  - Workers：リクエスト失敗、例外、主要操作（匿名化）
  - Supabase：RLS拒否/DBエラーを確認可能
- 運用
  - 環境：dev/prod（stgは不要）[TBD: 必要になったら追加]
  - バックアップ：Supabase標準の範囲で運用（無料枠前提）[TBD]
  - 監査ログの削除：保存期間（1年）に従い削除する運用を用意 [TBD]

## スコープ（In / Out / 将来）
- In（MVP）
  - 認証（メール=マジックリンク/Google/Apple）
  - 初回プロフィール（ニックネーム必須、変更可・チーム内一意、1-20文字/制御文字不可、ASCII英字は大小同一視）
  - チーム複数作成・切替、招待/参加（リンク生成のみ）
  - 家事/イベントのマスタ（登録/編集/無効化）
  - 実績のクイック登録、履歴（ページング）、編集/削除（当期+24h）
  - 精算周期（週次/月次）をチームごとに設定、周期ごとにポイント集計
  - 集計は全期間（過去周期）を参照可能
  - 監査ログ（重要操作）
- Out（MVPではやらない）
  - チーム削除（アーカイブ/完全削除）
  - 金銭の自動精算、決済連携
  - 高度な通知（プッシュ通知/リマインド）
  - 承認フロー（やったことの承認）
  - 多言語
- 将来
  - iPhoneネイティブ化（ラッパー/React Native等は方針検討）
  - ウィジェット、通知、テンプレ（マスタの共有テンプレ）
  - データエクスポート（CSV）

## 受け入れ条件（Definition of Done）
- 主要ユースケース1〜6が、スマホブラウザでデモできる
- 入力バリデーション（必須・型・範囲）と、ユーザー向けエラー表示がある
- RLSにより、(1)未参加チームのデータ取得、(2)メンバー権限でのマスタ/設定変更 が拒否される
- 周期集計が設定に従って表示され、周期切替（今期/前期）が動く（週次は月曜開始、月次は暦月、表示順はニックネーム昇順）
- 実績登録が集計に即時反映される（遅延がある場合はUIで説明）
- 実績の編集/削除が「本人またはオーナー」かつ「当期内（+周期終了後24時間猶予）」に限定され、権限外/期間外は拒否される
- オーナー不在になる操作が防止され、移譲フローでのみオーナー変更できる
- 監査ログが主要操作で記録され、追跡できる（閲覧はオーナーのみ、保存期間1年）
- 集計が全期間（過去周期）で参照できる（周期一覧は直近24期＋ページング）
- 履歴一覧がページングで閲覧できる（performed_at降順、1ページ既定50件）
- 本番デプロイ（Cloudflare）され、URLでアクセスできる
- READMEにローカル起動、環境変数、デプロイ手順が記載されている


